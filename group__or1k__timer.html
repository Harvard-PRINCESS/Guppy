<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.11"/>
<title>Barrelfish: Timer control</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Barrelfish
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.11 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div class="header">
  <div class="summary">
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle">
<div class="title">Timer control</div>  </div>
</div><!--header-->
<div class="contents">
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:ga432f34016f4f559c29b0be4fbc87e623"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__or1k__timer.html#ga432f34016f4f559c29b0be4fbc87e623">or1k_timer_init</a> (unsigned int hz)</td></tr>
<tr class="separator:ga432f34016f4f559c29b0be4fbc87e623"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:gaf760867d2f9d04f0c101c4c4975b0616"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__or1k__timer.html#gaf760867d2f9d04f0c101c4c4975b0616">or1k_timer_set_period</a> (uint32_t hz)</td></tr>
<tr class="separator:gaf760867d2f9d04f0c101c4c4975b0616"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga28914de74748e69a61db1ea7eb1ff553"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__or1k__timer.html#ga28914de74748e69a61db1ea7eb1ff553">or1k_timer_set_handler</a> (void(*handler)(void))</td></tr>
<tr class="separator:ga28914de74748e69a61db1ea7eb1ff553"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:gad50095aee03012b59fc5b6de5e0e9bdf"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__or1k__timer.html#gad50095aee03012b59fc5b6de5e0e9bdf">or1k_timer_set_mode</a> (uint32_t mode)</td></tr>
<tr class="separator:gad50095aee03012b59fc5b6de5e0e9bdf"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga369138d63850f2a4dfe216315c31f3d4"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__or1k__timer.html#ga369138d63850f2a4dfe216315c31f3d4">or1k_timer_enable</a> (void)</td></tr>
<tr class="separator:ga369138d63850f2a4dfe216315c31f3d4"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:gab40473a360aa82273575cdbc4381ac93"><td class="memItemLeft" align="right" valign="top">uint32_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__or1k__timer.html#gab40473a360aa82273575cdbc4381ac93">or1k_timer_disable</a> (void)</td></tr>
<tr class="separator:gab40473a360aa82273575cdbc4381ac93"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga0e392edcf73b9cf1c0279471ae59d241"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__or1k__timer.html#ga0e392edcf73b9cf1c0279471ae59d241">or1k_timer_restore</a> (uint32_t sr_tee)</td></tr>
<tr class="separator:ga0e392edcf73b9cf1c0279471ae59d241"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga48cd5b4c0bcc3c0b5ec28326426a66aa"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__or1k__timer.html#ga48cd5b4c0bcc3c0b5ec28326426a66aa">or1k_timer_pause</a> (void)</td></tr>
<tr class="separator:ga48cd5b4c0bcc3c0b5ec28326426a66aa"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga0bbdc374a3d140e538fc32b48b05df47"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__or1k__timer.html#ga0bbdc374a3d140e538fc32b48b05df47">or1k_timer_reset</a> (void)</td></tr>
<tr class="separator:ga0bbdc374a3d140e538fc32b48b05df47"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga2baa18c5153c793b7d2a85c6e224cea0"><td class="memItemLeft" align="right" valign="top">unsigned long&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__or1k__timer.html#ga2baa18c5153c793b7d2a85c6e224cea0">or1k_timer_get_ticks</a> (void)</td></tr>
<tr class="separator:ga2baa18c5153c793b7d2a85c6e224cea0"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga456bc40cdfbbbdfd62c936c065457cc2"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__or1k__timer.html#ga456bc40cdfbbbdfd62c936c065457cc2">or1k_timer_reset_ticks</a> (void)</td></tr>
<tr class="separator:ga456bc40cdfbbbdfd62c936c065457cc2"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<p>The tick timer can be used for time measurement, operating system scheduling etc. By default it is initialized to continuously count the ticks of a certain period after calling <a class="el" href="group__or1k__timer.html#ga432f34016f4f559c29b0be4fbc87e623">or1k_timer_init()</a>. The period can later be changed using <a class="el" href="group__or1k__timer.html#gaf760867d2f9d04f0c101c4c4975b0616">or1k_timer_set_period()</a>.</p>
<p>The timer is controlled using <a class="el" href="group__or1k__timer.html#ga369138d63850f2a4dfe216315c31f3d4">or1k_timer_enable()</a>, <a class="el" href="group__or1k__timer.html#gab40473a360aa82273575cdbc4381ac93">or1k_timer_disable()</a>, <a class="el" href="group__or1k__timer.html#ga0e392edcf73b9cf1c0279471ae59d241">or1k_timer_restore()</a>, <a class="el" href="group__or1k__timer.html#ga48cd5b4c0bcc3c0b5ec28326426a66aa">or1k_timer_pause()</a>. After initialization it is required to enable the timer the first time using <a class="el" href="group__or1k__timer.html#ga369138d63850f2a4dfe216315c31f3d4">or1k_timer_enable()</a>. <a class="el" href="group__or1k__timer.html#gab40473a360aa82273575cdbc4381ac93">or1k_timer_disable()</a> only disables the tick timer interrupts, it does not disable the timer counting. If you plan to use a pair of <a class="el" href="group__or1k__timer.html#gab40473a360aa82273575cdbc4381ac93">or1k_timer_disable()</a> and <a class="el" href="group__or1k__timer.html#ga369138d63850f2a4dfe216315c31f3d4">or1k_timer_enable()</a> to protect sections of your code against interrupts you should use <a class="el" href="group__or1k__timer.html#gab40473a360aa82273575cdbc4381ac93">or1k_timer_disable()</a> and <a class="el" href="group__or1k__timer.html#ga0e392edcf73b9cf1c0279471ae59d241">or1k_timer_restore()</a>, as it may be possible that the timer interrupt was not enabled before disabling it, enable would then start it unconditionally. <a class="el" href="group__or1k__timer.html#ga48cd5b4c0bcc3c0b5ec28326426a66aa">or1k_timer_pause()</a> pauses the counting.</p>
<p>In the default mode you can get the tick value using <a class="el" href="group__or1k__timer.html#ga2baa18c5153c793b7d2a85c6e224cea0">or1k_timer_get_ticks()</a> and reset this value using <a class="el" href="group__or1k__timer.html#ga456bc40cdfbbbdfd62c936c065457cc2">or1k_timer_reset_ticks()</a>.</p>
<p>Example for using the default mode:</p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> main() {</div><div class="line">  uint32_t ticks = 0;</div><div class="line">  uint32_t timerstate;</div><div class="line">  <a class="code" href="group__or1k__timer.html#ga432f34016f4f559c29b0be4fbc87e623">or1k_timer_init</a>(100);</div><div class="line">  <a class="code" href="group__or1k__timer.html#ga369138d63850f2a4dfe216315c31f3d4">or1k_timer_enable</a>();</div><div class="line">  <span class="keywordflow">while</span> (1) {</div><div class="line">    <span class="keywordflow">while</span> (ticks == <a class="code" href="group__or1k__timer.html#ga2baa18c5153c793b7d2a85c6e224cea0">or1k_timer_get_ticks</a>()) { }</div><div class="line">    timerstate = <a class="code" href="group__or1k__timer.html#gab40473a360aa82273575cdbc4381ac93">or1k_timer_disable</a>();</div><div class="line">    <span class="comment">// do something atomar</span></div><div class="line">    <a class="code" href="group__or1k__timer.html#ga0e392edcf73b9cf1c0279471ae59d241">or1k_timer_restore</a>(timerstate);</div><div class="line">    <span class="keywordflow">if</span> (ticks == 100) {</div><div class="line">      printf(<span class="stringliteral">&quot;A second elapsed\n&quot;</span>);</div><div class="line">      <a class="code" href="group__or1k__timer.html#ga456bc40cdfbbbdfd62c936c065457cc2">or1k_timer_reset_ticks</a>();</div><div class="line">      ticks = 0;</div><div class="line">    }</div><div class="line">  }</div><div class="line">}</div></div><!-- fragment --><p>It is possible to change the mode of the tick timer using <a class="el" href="group__or1k__timer.html#gad50095aee03012b59fc5b6de5e0e9bdf">or1k_timer_set_mode()</a>. Allowed values are the correct bit pattern (including the bit positions) for the TTMR register, it is recommended to use the macros defined in spr-defs.h. For example, implementing an operating system with scheduling decisions of varying duration favors the implementation of single run tick timer. Here, each quantum is started before leaving the operating system kernel. The counter can be restarted with <a class="el" href="group__or1k__timer.html#ga0bbdc374a3d140e538fc32b48b05df47">or1k_timer_reset()</a>. Example:</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> tick_handler(<span class="keywordtype">void</span>) {</div><div class="line">  <span class="comment">// Make schedule decision</span></div><div class="line">  <span class="comment">// and set new thread</span></div><div class="line">  <a class="code" href="group__or1k__timer.html#ga0bbdc374a3d140e538fc32b48b05df47">or1k_timer_reset</a>();</div><div class="line">  <span class="comment">// End of exception, new thread will run</span></div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">int</span> main() {</div><div class="line">  <span class="comment">// Configure operating system and start threads..</span></div><div class="line"></div><div class="line">  <span class="comment">// Configure timer</span></div><div class="line">  <a class="code" href="group__or1k__timer.html#ga432f34016f4f559c29b0be4fbc87e623">or1k_timer_init</a>(50);</div><div class="line">  <a class="code" href="group__or1k__timer.html#ga28914de74748e69a61db1ea7eb1ff553">or1k_timer_set_handler</a>(&amp;tick_handler);</div><div class="line">  <a class="code" href="group__or1k__timer.html#gad50095aee03012b59fc5b6de5e0e9bdf">or1k_timer_set_mode</a>(SPR_TTMR_SR);</div><div class="line">  <a class="code" href="group__or1k__timer.html#ga369138d63850f2a4dfe216315c31f3d4">or1k_timer_enable</a>();</div><div class="line"></div><div class="line">  <span class="comment">// Schedule first thread and die..</span></div><div class="line">}</div></div><!-- fragment --> <h2 class="groupheader">Function Documentation</h2>
<a class="anchor" id="gab40473a360aa82273575cdbc4381ac93"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">uint32_t or1k_timer_disable </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Disable timer interrupt</p>
<p>This disables the timer interrupt exception and returns the state of the interrupt exception enable flag before the call. This can be used with <a class="el" href="group__or1k__timer.html#ga0e392edcf73b9cf1c0279471ae59d241">or1k_timer_restore()</a> to implement sequences of code that are not allowed to be interrupted. Using <a class="el" href="group__or1k__timer.html#ga369138d63850f2a4dfe216315c31f3d4">or1k_timer_enable()</a> will unconditionally enable the interrupt independent of the state before calling <a class="el" href="group__or1k__timer.html#gab40473a360aa82273575cdbc4381ac93">or1k_timer_disable()</a>. For an example see <a class="el" href="group__or1k__timer.html">Timer control</a>.</p>
<dl class="section return"><dt>Returns</dt><dd>Status of timer interrupt before call</dd></dl>
<p>Disable tick timer</p>
<p>Disable timer interrupt in SR </p>

</div>
</div>
<a class="anchor" id="ga369138d63850f2a4dfe216315c31f3d4"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void or1k_timer_enable </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Enable timer interrupt</p>
<p>Enable the timer interrupt exception, independent of the status before. If you want to enable the timer conditionally, for example to implement a non-interruptible sequence of code, you should use <a class="el" href="group__or1k__timer.html#ga0e392edcf73b9cf1c0279471ae59d241">or1k_timer_restore()</a>. See the description of <a class="el" href="group__or1k__timer.html#gab40473a360aa82273575cdbc4381ac93">or1k_timer_disable()</a> for more details.</p>
<p>The enable will also restore the mode if the timer was paused previously.</p>
<p>Enable tick timer</p>
<p>Enable timer interrupt, install handler, load TTMR </p>

</div>
</div>
<a class="anchor" id="ga2baa18c5153c793b7d2a85c6e224cea0"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">unsigned long or1k_timer_get_ticks </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Get timer ticks</p>
<p>Get the global ticks of the default configuration. This will increment the tick counter according to the preconfigured period.</p>
<dl class="section return"><dt>Returns</dt><dd>Current value of ticks</dd></dl>
<p>Get tick timer</p>
<p>Return value of tick timer </p>

</div>
</div>
<a class="anchor" id="ga432f34016f4f559c29b0be4fbc87e623"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int or1k_timer_init </td>
          <td>(</td>
          <td class="paramtype">unsigned int&#160;</td>
          <td class="paramname"><em>hz</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Initialize tick timer</p>
<p>This initializes the tick timer in default mode (see <a class="el" href="group__or1k__timer.html">Timer control</a> for details).</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">hz</td><td>Initial period of the tick timer </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>0 if successful, -1 if timer not present</dd></dl>
<p>Enable tick timer</p>
<p>Install handler, calculate TTMR period, reset tick counter</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">hz</td><td>Rate at which to trigger timer ticks </td></tr>
  </table>
  </dd>
</dl>

</div>
</div>
<a class="anchor" id="ga48cd5b4c0bcc3c0b5ec28326426a66aa"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void or1k_timer_pause </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Pause timer counter</p>
<p>Pauses the counter of the tick timer. The counter will hold its current value and it can be started again with <a class="el" href="group__or1k__timer.html#ga369138d63850f2a4dfe216315c31f3d4">or1k_timer_enable()</a> which will restore the configured mode. </p>

</div>
</div>
<a class="anchor" id="ga0bbdc374a3d140e538fc32b48b05df47"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void or1k_timer_reset </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Reset timer counter </p>

</div>
</div>
<a class="anchor" id="ga456bc40cdfbbbdfd62c936c065457cc2"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void or1k_timer_reset_ticks </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Reset timer ticks</p>
<p>Resets the timer ticks in default configuration to 0.</p>
<p>Reset tick timer</p>
<p>Clear value of tick timer </p>

</div>
</div>
<a class="anchor" id="ga0e392edcf73b9cf1c0279471ae59d241"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void or1k_timer_restore </td>
          <td>(</td>
          <td class="paramtype">uint32_t&#160;</td>
          <td class="paramname"><em>sr_tee</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Restore timer interrupt exception flag</p>
<p>Restores the timer interrupt exception flag as returned by <a class="el" href="group__or1k__timer.html#gab40473a360aa82273575cdbc4381ac93">or1k_timer_disable()</a>. See the description of <a class="el" href="group__or1k__timer.html#gab40473a360aa82273575cdbc4381ac93">or1k_timer_disable()</a> and <a class="el" href="group__or1k__timer.html">Timer control</a> for details and an example.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">sr_tee</td><td>Status of timer interrupt </td></tr>
  </table>
  </dd>
</dl>

</div>
</div>
<a class="anchor" id="ga28914de74748e69a61db1ea7eb1ff553"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void or1k_timer_set_handler </td>
          <td>(</td>
          <td class="paramtype">void(*)(void)&#160;</td>
          <td class="paramname"><em>handler</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Replace the timer interrupt handler</p>
<p>By default the tick timer is used to handle timer ticks. The user can replace this with an own handler for example when implementing an operating system.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">handler</td><td>The callback function pointer to the handler </td></tr>
  </table>
  </dd>
</dl>

</div>
</div>
<a class="anchor" id="gad50095aee03012b59fc5b6de5e0e9bdf"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void or1k_timer_set_mode </td>
          <td>(</td>
          <td class="paramtype">uint32_t&#160;</td>
          <td class="paramname"><em>mode</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Set timer mode</p>
<p>The timer has different modes (see architecture manual). The default is to automatically restart counting (SPR_TTMR_RT), others are single run (SPR_TTMR_SR) and continuous run (SPR_TTMR_CR).</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">mode</td><td>a valid mode (use definitions from spr-defs.h as it is important that those are also at the correct position in the bit field!) </td></tr>
  </table>
  </dd>
</dl>

</div>
</div>
<a class="anchor" id="gaf760867d2f9d04f0c101c4c4975b0616"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void or1k_timer_set_period </td>
          <td>(</td>
          <td class="paramtype">uint32_t&#160;</td>
          <td class="paramname"><em>hz</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Set period of timer</p>
<p>Set the period of the timer to a value in Hz. The frequency from the board support package is used to determine the match value. </p>

</div>
</div>
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.11
</small></address>
</body>
</html>
