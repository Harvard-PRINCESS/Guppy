<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.11"/>
<title>Barrelfish: kernel/include/arch/armv7/paging_kernel_arch.h File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Barrelfish
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.11 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="dir_dc43877d82dd332f9fb2071fcca799d6.html">kernel</a></li><li class="navelem"><a class="el" href="dir_009f605b833ac4622acd6c3c0c26c0f0.html">include</a></li><li class="navelem"><a class="el" href="dir_b938bbc65f66dd090a6a00a71c65b7d8.html">arch</a></li><li class="navelem"><a class="el" href="dir_65cb4de5a52f274b32ea5bf529ab78dc.html">armv7</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="summary">
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle">
<div class="title">paging_kernel_arch.h File Reference</div>  </div>
</div><!--header-->
<div class="contents">

<p>ARM kernel page-table structures.  
<a href="#details">More...</a></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:af92b1f24b211fbe0c3c9a1a7787d0bbe"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="armv7_2paging__kernel__arch_8h.html#af92b1f24b211fbe0c3c9a1a7787d0bbe">paging_init</a> (lpaddr_t ram_base, size_t ram_size, struct <a class="el" href="structarm__core__data.html">arm_core_data</a> *boot_core_data)</td></tr>
<tr class="separator:af92b1f24b211fbe0c3c9a1a7787d0bbe"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a24c03eca210fb9fea2a0b340236f4868"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="armv7_2paging__kernel__arch_8h.html#a24c03eca210fb9fea2a0b340236f4868">enable_mmu</a> (lpaddr_t ttbr0, lpaddr_t ttbr1)</td></tr>
<tr class="separator:a24c03eca210fb9fea2a0b340236f4868"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:afa9de690f2001ee6f5343e67deda04e2"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="armv7_2paging__kernel__arch_8h.html#afa9de690f2001ee6f5343e67deda04e2">paging_map_vectors</a> (void)</td></tr>
<tr class="separator:afa9de690f2001ee6f5343e67deda04e2"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a5850888db0b270d5439db123caf56516"><td class="memItemLeft" align="right" valign="top">lvaddr_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="armv7_2paging__kernel__arch_8h.html#a5850888db0b270d5439db123caf56516">paging_map_device</a> (lpaddr_t base, size_t size)</td></tr>
<tr class="memdesc:a5850888db0b270d5439db123caf56516"><td class="mdescLeft">&#160;</td><td class="mdescRight">Map a device into the kernel's address space.  <a href="#a5850888db0b270d5439db123caf56516">More...</a><br /></td></tr>
<tr class="separator:a5850888db0b270d5439db123caf56516"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a2ecc089e244857a64e6b39c424666c2b"><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="a2ecc089e244857a64e6b39c424666c2b"></a>
bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="armv7_2paging__kernel__arch_8h.html#a2ecc089e244857a64e6b39c424666c2b">paging_mmu_enabled</a> (void)</td></tr>
<tr class="memdesc:a2ecc089e244857a64e6b39c424666c2b"><td class="mdescLeft">&#160;</td><td class="mdescRight">Return whether we have enabled the MMU. Useful for initialization assertions. <br /></td></tr>
<tr class="separator:a2ecc089e244857a64e6b39c424666c2b"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a575ee2b66e30b3fabe031e3c017e0b4f"><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="a575ee2b66e30b3fabe031e3c017e0b4f"></a>
void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="armv7_2paging__kernel__arch_8h.html#a575ee2b66e30b3fabe031e3c017e0b4f">paging_map_user_pages_l1</a> (lvaddr_t table_addr, lvaddr_t vaddr, lpaddr_t paddr)</td></tr>
<tr class="memdesc:a575ee2b66e30b3fabe031e3c017e0b4f"><td class="mdescLeft">&#160;</td><td class="mdescRight">Install a page table pointer in a level 1 page table located at 'table_base' to map addresses starting at virtual address 'va'. The level 2 page table to be used is assumed to be located at physical address 'pa'. <br /></td></tr>
<tr class="separator:a575ee2b66e30b3fabe031e3c017e0b4f"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a89ba93a90328c168df5e845f8b6818ad"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="armv7_2paging__kernel__arch_8h.html#a89ba93a90328c168df5e845f8b6818ad">paging_set_l2_entry</a> (uintptr_t *l2entry, lpaddr_t paddr, uintptr_t flags)</td></tr>
<tr class="separator:a89ba93a90328c168df5e845f8b6818ad"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a376754ac6f908b9677ef29fc105983a8"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="armv7_2paging__kernel__arch_8h.html#a376754ac6f908b9677ef29fc105983a8">paging_context_switch</a> (lpaddr_t table_addr)</td></tr>
<tr class="separator:a376754ac6f908b9677ef29fc105983a8"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>ARM kernel page-table structures. </p>
</div><h2 class="groupheader">Function Documentation</h2>
<a class="anchor" id="a24c03eca210fb9fea2a0b340236f4868"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void enable_mmu </td>
          <td>(</td>
          <td class="paramtype">lpaddr_t&#160;</td>
          <td class="paramname"><em>ttbr0</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">lpaddr_t&#160;</td>
          <td class="paramname"><em>ttbr1</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>TTBCR: Translation Table Base Control register. TTBCR.N is bits[2:0] In a TLB miss TTBCR.N determines whether TTBR0 or TTBR1 is used as the base address for the translation table walk in memory: N == 0 -&gt; always use TTBR0 N &gt; 0 -&gt; if VA[31:32-N] &gt; 0 use TTBR1 else use TTBR0</p>
<p>TTBR0 is typically used for processes-specific addresses TTBR1 is typically used for OS addresses that do not change on context switch</p>
<p>set TTBCR.N = 1 to use TTBR1 for VAs &gt;= MEMORY_OFFSET (=2GB)</p>

</div>
</div>
<a class="anchor" id="a376754ac6f908b9677ef29fc105983a8"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void paging_context_switch </td>
          <td>(</td>
          <td class="paramtype">lpaddr_t&#160;</td>
          <td class="paramname"><em>ttbr</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>/brief Perform a context switch. Reload TTBR0 with the new address, and invalidate the TLBs and caches. </p>

</div>
</div>
<a class="anchor" id="af92b1f24b211fbe0c3c9a1a7787d0bbe"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void paging_init </td>
          <td>(</td>
          <td class="paramtype">lpaddr_t&#160;</td>
          <td class="paramname"><em>ram_base</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">size_t&#160;</td>
          <td class="paramname"><em>ram_size</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structarm__core__data.html">arm_core_data</a> *&#160;</td>
          <td class="paramname"><em>boot_core_data</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Create kernel page tables.</p>
<p>We use 1MB (ARM_L1_SECTION_BYTES) pages (sections) with a single-level table. This allows 1MB*4k (ARM_L1_MAX_ENTRIES) = 4G per pagetable.</p>
<p>Hardware details can be found in: ARM Architecture Reference Manual, ARMv7-A and ARMv7-R edition B3: Virtual Memory System Architecture (VMSA) </p>
<p>Make sure our page tables are correctly aligned in memory</p>
<p>On many ARMv7-A platforms, physical RAM (phys_memory_start) is the same as the offset of mapped physical memory within virtual address space (phys_memory_start). Some platforms (such as the Zynq) break this rule, and thus we need to be very careful about how we enable the MMU.</p>
<p>Zero the page tables: this has the effect of marking every PTE as invalid.</p>
<p>Now we lay out the kernel's virtual address space.</p>
<p>00000000-7FFFFFFFF: 1-1 mappings (hardware we have not mapped into high kernel space yet, and the init code that is currently executing, in case RAM doesn't start at 80000000). 80000000-BFFFFFFFF: 1-1 mappings (this is 1GB of RAM). C0000000-FEFFFFFFF: On-demand mappings of hardware devices, allocated descending from DEVICE_OFFSET. FF000000-FFEFFFFFF: Unallocated. FFF00000-FFFFFFFFF: L2 table, containing: FFF00000-FFFEFFFF: Unallocated FFFF0000-FFFFFFFF: Exception vectors</p>

</div>
</div>
<a class="anchor" id="a5850888db0b270d5439db123caf56516"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">lvaddr_t paging_map_device </td>
          <td>(</td>
          <td class="paramtype">lpaddr_t&#160;</td>
          <td class="paramname"><em>dev_base</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">size_t&#160;</td>
          <td class="paramname"><em>dev_size</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Map a device into the kernel's address space. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">device_base</td><td>is the physical address of the device </td></tr>
    <tr><td class="paramname">device_size</td><td>is the number of bytes of physical address space the device occupies.</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>the kernel virtual address of the mapped device, or panic. </dd></dl>

</div>
</div>
<a class="anchor" id="afa9de690f2001ee6f5343e67deda04e2"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void paging_map_vectors </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Install a single small page mapping to cover the vectors.</p>
<p>The mapping fields are set exactly as for the kernel's RAM sections - see make_ram_section() for details.</p>
<p>Map the L2 table to hold the high vectors mapping.</p>

</div>
</div>
<a class="anchor" id="a89ba93a90328c168df5e845f8b6818ad"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void paging_set_l2_entry </td>
          <td>(</td>
          <td class="paramtype">uintptr_t *&#160;</td>
          <td class="paramname"><em>l2e</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">lpaddr_t&#160;</td>
          <td class="paramname"><em>addr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">uintptr_t&#160;</td>
          <td class="paramname"><em>flags</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>/brief Install a level 2 page table entry located at l2e, to map physical address 'pa', with flags 'flags'. 'flags' here is in the form of a prototype 32-bit L2 <em>invalid</em> PTE with address 0. </p>

</div>
</div>
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.11
</small></address>
</body>
</html>
